{% extends 'base.html' %}

{% block content %}
<section class="section" style="background: #f7f8fa; min-height: 100vh;">
    <div class="container">
        <div class="columns">
            <!-- COLONNE GAUCHE : ÉQUIPE & INVENTAIRE -->
            <div class="column is-one-third">
                <div class="box mb-5">
                    <h2 class="title is-4">Équipe</h2>
                    <table class="table is-fullwidth is-hoverable">
                        <thead>
                            <tr><th>Nom</th><th>Rôle</th><th>Couleur</th><th></th></tr>
                        </thead>
                        <tbody>
                            {% for employe in employes %}
                            <tr>
                                <td>{{ employe.nom }}</td>
                                <td>{{ employe.role }}</td>
                                <td>
                                    {% if employe.couleur %}
                                        <span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:{{ employe.couleur }}; border:1px solid #ccc;vertical-align:middle;"></span>
                                        <span style="font-size:0.9em;vertical-align:middle;">{{ employe.couleur }}</span>
                                    {% else %}-{% endif %}
                                </td>
                                <td class="has-text-right">
                                    <button class="button is-small is-info js-edit-employe" data-id="{{ employe.id }}" data-nom="{{ employe.nom }}" data-role="{{ employe.role }}" data-couleur="{{ employe.couleur or '' }}">Modifier</button>
                                    <form method="post" action="{{ url_for('supprimer_employe', employe_id=employe.id) }}" style="display:inline;">
                                        <button class="button is-danger is-small ml-1" onclick="return confirm('Supprimer cet employé ?');">Supprimer</button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="has-text-centered">Aucun employé.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button class="button is-primary is-fullwidth mt-2" id="btn-ajouter-employe">Ajouter un employé</button>
                </div>
                                <div class="box">
                                    <div style="display:flex; align-items:center; cursor:pointer;" id="toggle-inventaire">
                                        <h2 class="title is-4" style="flex:1; margin-bottom:0;">Inventaire</h2>
                                        <span id="inventaire-arrow" style="transition: transform 0.2s; font-size:1.5rem;">&#9660;</span>
                                    </div>
                                    <div id="inventaire-content">
                                        <table class="table is-fullwidth is-hoverable is-narrow">
                                                <thead>
                                                        <tr><th>Nom</th><th>Réf.</th><th class="has-text-centered">Qté</th><th></th></tr>
                                                </thead>
                                                <tbody>
                                                        {% for fourniture in fournitures %}
                                                        <tr>
                                                                <td>{{ fourniture.nom }}</td>
                                                                <td>{{ fourniture.reference or '-' }}</td>
                                                                <td class="has-text-centered">{{ fourniture.quantite }}</td>
                                                                <td class="has-text-right">
                                                                        <button class="button is-small is-info js-edit-fourniture" data-id="{{ fourniture.id }}" data-nom="{{ fourniture.nom }}" data-reference="{{ fourniture.reference or '' }}" data-quantite="{{ fourniture.quantite }}">Modifier</button>
                                                                        <form method="post" action="{{ url_for('supprimer_parametre', type='fourniture', id=fourniture.id) }}" style="display:inline;">
                                                                                <button class="button is-danger is-small ml-1" onclick="return confirm('Supprimer cette fourniture ?');">Supprimer</button>
                                                                        </form>
                                                                </td>
                                                        </tr>
                                                        {% else %}
                                                        <tr><td colspan="4" class="has-text-centered">Aucune fourniture.</td></tr>
                                                        {% endfor %}
                                                </tbody>
                                        </table>
                                        <button class="button is-primary is-fullwidth mt-2" id="btn-ajouter-fourniture">Ajouter une fourniture</button>
                                    </div>
                                </div>
            </div>
            <!-- COLONNE DROITE : PRESTATIONS -->
            <div class="column is-two-thirds">
                <div class="box">
                  <div style="display:flex; align-items:center; cursor:pointer;" id="toggle-prestations">
                    <h2 class="title is-4" style="flex:1; margin-bottom:0;">Prestations & Tarifs</h2>
                    <span id="prestations-arrow" style="transition: transform 0.2s; font-size:1.5rem;">&#9660;</span>
                  </div>
                  <div id="prestations-content">
                    <button class="button is-primary mb-3" id="btn-ajouter-categorie">Ajouter une catégorie</button>
                    <div id="categories-accordeon">
                        {% for cat in categories %}
                        <div class="box mb-4">
                            <div class="level is-mobile cat-toggle" style="cursor:pointer;" data-cat-id="{{ cat.id }}">
                                <div class="level-left">
                                    <span class="cat-arrow" style="transition: transform 0.2s; font-size:1.3rem; margin-right:8px;">&#9660;</span>
                                    <strong class="is-size-5">{{ cat.nom }}</strong>
                                </div>
                                <div class="level-right">
                                    <button class="button is-small is-info js-edit-categorie" data-id="{{ cat.id }}" data-nom="{{ cat.nom }}" onclick="event.stopPropagation();">Modifier</button>
                                    <form method="post" action="{{ url_for('supprimer_parametre', type='categorie', id=cat.id) }}" style="display:inline;" onclick="event.stopPropagation();">
                                        <button class="button is-danger is-small ml-1" onclick="return confirm('Supprimer cette catégorie et tout son contenu ?');">Supprimer</button>
                                    </form>
                                </div>
                            </div>
                            <div class="cat-content" data-cat-id="{{ cat.id }}">
                                <button class="button is-link is-light is-small mt-2 mb-2 js-ajouter-sous-categorie" data-categorie-id="{{ cat.id }}">Ajouter une sous-catégorie</button>
                                {% for sc in cat.sous_categories %}
                                <div class="box mb-2">
                                    <div class="level is-mobile">
                                        <div class="level-left">
                                            <span class="is-size-6">{{ sc.nom }}</span>
                                        </div>
                                        <div class="level-right">
                                            <button class="button is-small is-info js-edit-sous-categorie" data-id="{{ sc.id }}" data-nom="{{ sc.nom }}">Modifier</button>
                                            <form method="post" action="{{ url_for('supprimer_parametre', type='sous_categorie', id=sc.id) }}" style="display:inline;">
                                                <button class="button is-danger is-small ml-1" onclick="return confirm('Supprimer cette sous-catégorie et ses prestations ?');">Supprimer</button>
                                            </form>
                                        </div>
                                    </div>
                                    <button class="button is-link is-light is-small mt-2 mb-2 js-ajouter-prestation" data-sous-categorie-id="{{ sc.id }}">Ajouter une prestation</button>
                                    <table class="table is-fullwidth is-hoverable is-narrow mt-2">
                                        <thead>
                                            <tr><th>Prestation</th><th>Prix</th><th></th></tr>
                                        </thead>
                                        <tbody>
                                            {% for detail in sc.details_retouches %}
                                            <tr>
                                                <td>{{ detail.nom }}</td>
                                                <td class="has-text-right">
                                                    <span class="price-text" data-id="{{ detail.id }}">{{ "%.2f"|format(detail.prix) if detail.prix is not none else '-' }}</span>
                                                    <button class="button is-small is-info is-light edit-price-btn ml-2" data-id="{{ detail.id }}">Modifier</button>
                                                </td>
                                                <td class="has-text-right">
                                                    <form method="post" action="{{ url_for('supprimer_parametre', type='detail', id=detail.id) }}" style="display:inline;">
                                                        <button class="button is-danger is-small ml-1" onclick="return confirm('Supprimer cette prestation ?');">Supprimer</button>
                                                    </form>
                                                </td>
                                            </tr>
                                            {% else %}
                                            <tr><td colspan="3" class="has-text-centered">Aucune prestation.</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% else %}
                        <div class="notification is-info">Aucune catégorie créée.</div>
                        {% endfor %}
                    </div>
                  </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- MODALES (pop-ups) pour édition/ajout -->
<div id="modal-edit-employe" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Modifier l'employé</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <form id="form-edit-employe" method="post">
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Nom</label>
                    <input class="input" type="text" name="nom" required>
                </div>
                <div class="field">
                    <label class="label">Rôle</label>
                    <input class="input" type="text" name="role" required>
                </div>
                <div class="field">
                    <label class="label">Couleur (affichage planning)</label>
                    <input class="input" type="color" name="couleur" style="width:60px; padding:0; height:2.5em;">
                </div>
            </section>
            <footer class="modal-card-foot">
                <button type="submit" class="button is-success">Enregistrer</button>
                <button type="button" class="button js-close-modal">Annuler</button>
            </footer>
        </form>
    </div>
</div>

<div id="modal-edit-fourniture" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Modifier la fourniture</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <form id="form-edit-fourniture" method="post">
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Nom</label>
                    <input class="input" type="text" name="nom" required>
                </div>
                <div class="field">
                    <label class="label">Référence</label>
                    <input class="input" type="text" name="reference">
                </div>
                <div class="field">
                    <label class="label">Quantité</label>
                    <input class="input" type="number" name="quantite" required>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button type="submit" class="button is-success">Enregistrer</button>
                <button type="button" class="button js-close-modal">Annuler</button>
            </footer>
        </form>
    </div>
</div>

<div id="modal-edit-categorie" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Modifier la catégorie</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <form id="form-edit-categorie" method="post">
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Nom</label>
                    <input class="input" type="text" name="nom" required>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button type="submit" class="button is-success">Enregistrer</button>
                <button type="button" class="button js-close-modal">Annuler</button>
            </footer>
        </form>
    </div>
</div>

<div id="modal-edit-sous-categorie" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Modifier la sous-catégorie</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <form id="form-edit-sous-categorie" method="post">
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Nom</label>
                    <input class="input" type="text" name="nom" required>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button type="submit" class="button is-success">Enregistrer</button>
                <button type="button" class="button js-close-modal">Annuler</button>
            </footer>
        </form>
    </div>
</div>

<div id="modal-edit-prestation" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Modifier la prestation</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <form id="form-edit-prestation" method="post">
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Nom</label>
                    <input class="input" type="text" name="nom" required>
                </div>
                <div class="field">
                    <label class="label">Prix (€)</label>
                    <input class="input" type="number" step="0.01" name="prix">
                </div>
            </section>
            <footer class="modal-card-foot">
                <button type="submit" class="button is-success">Enregistrer</button>
                <button type="button" class="button js-close-modal">Annuler</button>
            </footer>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Accordéons
window.toggleAccordion = function(id, arrowId) {
    var content = document.getElementById(id);
    if (content) {
        if(content.style.display === 'none' || content.style.display === '') {
            content.style.display = 'block';
            if(arrowId) {
                var arrow = document.getElementById(arrowId);
                if(arrow) arrow.style.transform = 'rotate(0deg)';
            }
        } else {
            content.style.display = 'none';
            if(arrowId) {
                var arrow = document.getElementById(arrowId);
                if(arrow) arrow.style.transform = 'rotate(-90deg)';
            }
        }
    }
};

document.addEventListener('DOMContentLoaded', function () {
    // --- Accordéon Inventaire ---
    var toggleInv = document.getElementById('toggle-inventaire');
    var invContent = document.getElementById('inventaire-content');
    var invArrow = document.getElementById('inventaire-arrow');
    if(toggleInv && invContent && invArrow) {
        toggleInv.addEventListener('click', function() {
            if(invContent.style.display === 'none' || invContent.style.display === '') {
                invContent.style.display = 'block';
                invArrow.style.transform = 'rotate(0deg)';
            } else {
                invContent.style.display = 'none';
                invArrow.style.transform = 'rotate(-90deg)';
            }
        });
        // Par défaut ouvert
        invContent.style.display = 'block';
    }

    // --- Accordéon Prestations ---
    var togglePres = document.getElementById('toggle-prestations');
    var presContent = document.getElementById('prestations-content');
    var presArrow = document.getElementById('prestations-arrow');
    if(togglePres && presContent && presArrow) {
        togglePres.addEventListener('click', function() {
            if(presContent.style.display === 'none' || presContent.style.display === '') {
                presContent.style.display = 'block';
                presArrow.style.transform = 'rotate(0deg)';
            } else {
                presContent.style.display = 'none';
                presArrow.style.transform = 'rotate(-90deg)';
            }
        });
        // Par défaut ouvert
        presContent.style.display = 'block';
    }

    // Accordéons pour chaque catégorie de prestations
    document.querySelectorAll('.cat-toggle').forEach(function(toggle) {
        var catId = toggle.getAttribute('data-cat-id');
        var content = document.querySelector('.cat-content[data-cat-id="' + catId + '"]');
        var arrow = toggle.querySelector('.cat-arrow');
        if(content && arrow) {
            content.style.display = 'block';
            arrow.style.transform = 'rotate(0deg)';
            toggle.addEventListener('click', function(e) {
                if(content.style.display === 'none') {
                    content.style.display = 'block';
                    arrow.style.transform = 'rotate(0deg)';
                } else {
                    content.style.display = 'none';
                    arrow.style.transform = 'rotate(-90deg)';
                }
            });
        }
    });

    // --- MODALES ---
    function openModal(id) {
        document.getElementById(id).classList.add('is-active');
    }
    function closeModalAll() {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('is-active'));
    }
    document.querySelectorAll('.js-close-modal, .modal .delete, .modal-background').forEach(btn => {
        btn.addEventListener('click', closeModalAll);
    });

    // --- ÉQUIPE ---
    document.getElementById('btn-ajouter-employe').onclick = function() {
        document.getElementById('form-edit-employe').reset();
        document.getElementById('form-edit-employe').action = '/parametres/employe/ajouter';
        document.getElementById('form-edit-employe').couleur.value = '#2196f3'; // couleur par défaut
        openModal('modal-edit-employe');
    };
    document.querySelectorAll('.js-edit-employe').forEach(btn => {
        btn.onclick = function() {
            document.getElementById('form-edit-employe').action = '/modifier_employe/' + btn.dataset.id;
            document.getElementById('form-edit-employe').nom.value = btn.dataset.nom;
            document.getElementById('form-edit-employe').role.value = btn.dataset.role;
            document.getElementById('form-edit-employe').couleur.value = btn.dataset.couleur || '#2196f3';
            openModal('modal-edit-employe');
        };
    });

    // --- INVENTAIRE ---
    document.getElementById('btn-ajouter-fourniture').onclick = function() {
        document.getElementById('form-edit-fourniture').reset();
        document.getElementById('form-edit-fourniture').action = '/ajouter_fourniture';
        openModal('modal-edit-fourniture');
    };
    document.querySelectorAll('.js-edit-fourniture').forEach(btn => {
        btn.onclick = function() {
            document.getElementById('form-edit-fourniture').action = '/modifier_fourniture/' + btn.dataset.id;
            document.getElementById('form-edit-fourniture').nom.value = btn.dataset.nom;
            document.getElementById('form-edit-fourniture').reference.value = btn.dataset.reference;
            document.getElementById('form-edit-fourniture').quantite.value = btn.dataset.quantite;
            openModal('modal-edit-fourniture');
        };
    });

    // --- CATÉGORIES ---
    document.getElementById('btn-ajouter-categorie').onclick = function() {
        document.getElementById('form-edit-categorie').reset();
        document.getElementById('form-edit-categorie').action = '/parametres/categorie/ajouter';
        openModal('modal-edit-categorie');
    };
    document.querySelectorAll('.js-edit-categorie').forEach(btn => {
        btn.onclick = function() {
            document.getElementById('form-edit-categorie').action = '/parametres/categorie/modifier/' + btn.dataset.id;
            document.getElementById('form-edit-categorie').nom.value = btn.dataset.nom;
            openModal('modal-edit-categorie');
        };
    });

    // --- SOUS-CATÉGORIES ---
    document.querySelectorAll('.js-ajouter-sous-categorie').forEach(btn => {
        btn.onclick = function() {
            document.getElementById('form-edit-sous-categorie').reset();
            document.getElementById('form-edit-sous-categorie').action = '/ajouter_sous_categorie?categorie_id=' + btn.dataset.categorieId;
            openModal('modal-edit-sous-categorie');
        };
    });
    document.querySelectorAll('.js-edit-sous-categorie').forEach(btn => {
        btn.onclick = function() {
            document.getElementById('form-edit-sous-categorie').action = '/parametres/sous_categorie/modifier/' + btn.dataset.id;
            document.getElementById('form-edit-sous-categorie').nom.value = btn.dataset.nom;
            openModal('modal-edit-sous-categorie');
        };
    });

    // --- PRESTATIONS ---
    document.querySelectorAll('.js-ajouter-prestation').forEach(btn => {
        btn.onclick = function() {
            document.getElementById('form-edit-prestation').reset();
            document.getElementById('form-edit-prestation').action = '/ajouter_detail_retouche?sous_categorie_id=' + btn.dataset.sousCategorieId;
            openModal('modal-edit-prestation');
        };
    });
    document.querySelectorAll('.edit-price-btn').forEach(btn => {
        btn.onclick = function() {
            document.getElementById('form-edit-prestation').action = '/parametres/prestation/modifier/' + btn.dataset.id;
            document.getElementById('form-edit-prestation').nom.value = btn.closest('tr').querySelector('td').innerText;
            document.getElementById('form-edit-prestation').prix.value = btn.closest('tr').querySelector('.price-text').innerText.replace(',', '.');
            openModal('modal-edit-prestation');
        };
    });

    // Fermer modale avec Echap
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeModalAll();
    });
});
</script>
{% endblock %}