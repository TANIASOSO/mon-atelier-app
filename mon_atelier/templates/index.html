
{% extends 'base.html' %}

{% block content %}
<section class="section" style="background: #eaf3fa; min-height: 100vh;">
  <div style="display: flex; gap: 0; max-width: 1400px; margin: 0 auto; box-shadow: 0 4px 32px #e0e0e0; border-radius: 24px; overflow: hidden; background: #fff;">
    <!-- Colonne de gauche -->
    <aside style="width: 320px; background: #f7f7f7; border-right: 2px solid #e0e0e0; padding: 2rem 1.2rem 1.2rem 1.2rem; display: flex; flex-direction: column; min-height: 900px;">
      <!-- Mini calendrier -->
      <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 1.2rem;">
        <!-- Mini calendrier VanillaJS Datepicker -->
        <div id="mini-calendar" style="width: 100%; min-height: 260px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #e0e0e0; padding: 0.5em 0.2em;"></div>
      </div>
  <button id="ajout-event-btn" style="margin: 1.2rem 0 1.5rem 0; background: #a18aff; border: none; border-radius: 12px; width: 100%; height: 38px; color: #fff; font-weight: 600; font-size: 1.1rem; cursor: pointer;">+ Ajouter un événement</button>
      <div style="font-size: 0.95rem; color: #888; margin-bottom: 1.2rem;">"D'abord le café. Ensuite, les projets."<br><span style="font-size:0.85em; color:#bbb;">– Leanna Renee Hieber</span></div>
      <!-- Objectifs -->
      <div style="margin-bottom: 1.2rem;">
        <div style="font-weight: 600; color: #222; margin-bottom: 0.5rem;">Objectifs</div>
        <ul id="goals-list" style="list-style: none; padding: 0; color: #444; font-size: 1rem;"></ul>
        <form id="add-goal-form" style="display:flex;gap:0.5em;margin-top:0.7em;">
          <input id="new-goal-input" type="text" placeholder="Nouvel objectif..." style="flex:1;padding:0.3em 0.7em;border-radius:6px;border:1px solid #ccc;font-size:1em;" />
          <button type="submit" style="background:#a18aff;color:#fff;border:none;border-radius:6px;padding:0.3em 1em;font-weight:600;cursor:pointer;">Ajouter</button>
        </form>
      </div>
    </aside>

    <!-- Calendrier principal -->
    <main style="flex: 1; padding: 2.5rem 2rem 2rem 2rem; background: #fff;">
      <div id="calendar-accueil"></div>
    </main>
  </div>
  <link href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Gestion des objectifs (localStorage)
      const goalsList = document.getElementById('goals-list');
      const addGoalForm = document.getElementById('add-goal-form');
      const newGoalInput = document.getElementById('new-goal-input');

      function loadGoals() {
        const goals = JSON.parse(localStorage.getItem('goals') || '[]');
        goalsList.innerHTML = '';
        goals.forEach((goal, idx) => {
          const li = document.createElement('li');
          li.textContent = goal;
          li.style.marginBottom = '0.3em';
          // Ajout bouton suppression
          const delBtn = document.createElement('button');
          delBtn.textContent = '✕';
          delBtn.className = 'button is-small is-light';
          delBtn.style.marginLeft = '0.7em';
          delBtn.onclick = function() {
            removeGoal(idx);
          };
          li.appendChild(delBtn);
          goalsList.appendChild(li);
        });
      }

      function addGoal(goal) {
        if (!goal.trim()) return;
        const goals = JSON.parse(localStorage.getItem('goals') || '[]');
        goals.push(goal);
        localStorage.setItem('goals', JSON.stringify(goals));
        loadGoals();
      }

      function removeGoal(idx) {
        const goals = JSON.parse(localStorage.getItem('goals') || '[]');
        goals.splice(idx, 1);
        localStorage.setItem('goals', JSON.stringify(goals));
        loadGoals();
      }

      if (addGoalForm && newGoalInput && goalsList) {
        addGoalForm.addEventListener('submit', function(e) {
          e.preventDefault();
          addGoal(newGoalInput.value);
          newGoalInput.value = '';
        });
        loadGoals();
      }
      // Gestion modale Bulma pour ajout d'événement
      var modal = document.getElementById('modal-ajout-event');
      var openBtn = document.getElementById('ajout-event-btn');
      var closeBtns = modal ? modal.querySelectorAll('.modal-background, .modal-close, .modal-cancel') : [];
      if (openBtn && modal) {
        openBtn.addEventListener('click', function() {
          modal.classList.add('is-active');
        });
        closeBtns.forEach(function(btn) {
          btn.addEventListener('click', function() {
            modal.classList.remove('is-active');
          });
        });
      }
      // Mini calendrier VanillaJS Datepicker
      var miniCalEl = document.getElementById('mini-calendar');
      if (miniCalEl) {
        new Datepicker(miniCalEl, {
          calendarWeeks: true,
          todayHighlight: true
        });
      }

      // Calendrier principal FullCalendar
      var calendarEl = document.getElementById('calendar-accueil');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'fr',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: {
          dayGridMonth: 'Mois',
          timeGridWeek: 'Semaine',
          timeGridDay: 'Jour'
        },
        events: '/api/shifts_events',
        eventClick: function(info) {
            // Affiche les détails de l'événement dans la modale
            document.getElementById('modal-event-title').innerText = info.event.title;
            document.getElementById('modal-event-start').innerText = info.event.start.toLocaleString('fr-FR');
            // Configure les liens des boutons
            let eventId = info.event.extendedProps.shift_id;
            document.getElementById('modal-edit-link').href = `/shift/modifier/${eventId}`;
            document.getElementById('modal-delete-form').action = `/shift/supprimer/${eventId}`;
            // Ouvre la modale
            document.getElementById('modal-view-event').classList.add('is-active');
        }
      });
      calendar.render();
    });

    // Gestion fermeture de la modale d'événement
    document.addEventListener('DOMContentLoaded', function() {
      var modal = document.getElementById('modal-view-event');
      if (modal) {
        modal.querySelector('.delete').addEventListener('click', function() {
          modal.classList.remove('is-active');
        });
        modal.querySelector('.modal-background').addEventListener('click', function() {
          modal.classList.remove('is-active');
        });
      }
    });
  </script>

  <!-- Modale Bulma pour ajout d'événement -->
  <div class="modal" id="modal-ajout-event">
  <!-- Modale pour voir/modifier/supprimer un événement -->
  <div id="modal-view-event" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Détail de l'événement</p>
        <button class="delete" aria-label="close"></button>
      </header>
      <section class="modal-card-body">
        <p><strong>Tâche :</strong> <span id="modal-event-title"></span></p>
        <p><strong>Début :</strong> <span id="modal-event-start"></span></p>
      </section>
      <footer class="modal-card-foot">
        <a id="modal-edit-link" href="#" class="button is-success">Modifier</a>
        <form id="modal-delete-form" method="POST" style="margin-left: 10px;">
            <button class="button is-danger" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet événement ?');">Supprimer</button>
        </form>
      </footer>
    </div>
  </div>
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Ajouter un événement</p>
        <button class="delete modal-close" aria-label="close"></button>
      </header>
      <form method="POST" action="{{ url_for('ajouter_shift') }}">
        <section class="modal-card-body">
          <div class="field">
            <label class="label">Date</label>
            <div class="control">
              <input type="date" name="date" required>
            </div>
          </div>
          <div class="field is-grouped">
            <div class="control" style="flex:1;">
              <label class="label">Heure début</label>
              <input type="time" name="heure_debut" required>
            </div>
            <div class="control" style="flex:1;">
              <label class="label">Heure fin</label>
              <input type="time" name="heure_fin" required>
            </div>
          </div>
          <div class="field">
            <label class="label">Tâche</label>
            <div class="control">
              <input type="text" name="tache" placeholder="Ex : Accueil, Atelier...">
            </div>
          </div>
        </section>
        <footer class="modal-card-foot">
          <button type="submit" class="button is-success">Enregistrer</button>
          <button type="button" class="button modal-cancel">Annuler</button>
        </footer>
      </form>
    </div>
  </div>
  <style>
    #agenda-calendar .fc-daygrid-day {
      min-height: 110px;
      vertical-align: top;
      background: #fff;
      border: 1.5px solid #e0e0e0;
      border-radius: 0;
      padding: 0.5em 0.3em 0.3em 0.3em;
    }
    #agenda-calendar .fc-day-today {
      background: #f7f0ff !important;
      border: 2px solid #a18aff;
    }
    #agenda-calendar .fc-event {
      border-radius: 8px;
      font-size: 1.05rem;
      padding: 4px 8px;
      margin-bottom: 4px;
      font-family: 'Montserrat', Arial, sans-serif;
      font-weight: 500;
      box-shadow: 0 2px 8px #e0e0e0;
    }
    #agenda-calendar .fc-toolbar-title {
      font-size: 2.1rem;
      font-weight: 800;
      color: #222;
      letter-spacing: 1px;
      margin-bottom: 1.2rem;
    }
    #sidebar-calendar {
      margin-bottom: 1.2rem;
      min-height: 260px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px #e0e0e0;
      padding: 0.5em 0.2em;
    }
    .fc .fc-button-primary {
      background: #a18aff;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 2px 8px #e0e0e0;
      margin: 0 2px;
    }
    .fc .fc-button-primary:focus {
      outline: none;
      box-shadow: 0 0 0 2px #a18aff;
    }
    #agenda-calendar .fc-timegrid-axis-all-day, #agenda-calendar .fc-timegrid-all-day {
      display: none !important;
    }
    #agenda-calendar .fc-event-time {
      display: none !important;
    }
  </style>
</section>
{% endblock %}