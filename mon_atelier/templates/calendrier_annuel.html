{% extends 'base.html' %}

{% block content %}
<section class="section" style="background: #eaf3fa; min-height: 100vh;">
	<div style="display:flex; max-width: 1200px; margin: 0 auto;">
		<!-- Sidebar -->
		<aside style="width: 240px; min-width:200px; background: #f6f6ff; border-radius: 18px; box-shadow: 0 2px 8px #ececff; padding: 2rem 1rem 1.5rem 1rem; margin-right:2.5rem; display:flex; flex-direction:column; align-items:center;">
			<!-- Menu navigation -->
			<nav style="width:100%; margin-bottom:2rem;">
				<ul style="list-style:none; padding:0; margin:0;">
					<li style="margin-bottom:1rem;"><a href="{{ url_for('planning') }}" class="button is-fullwidth is-light">Semaine</a></li>
					<li style="margin-bottom:1rem;"><a href="{{ url_for('calendrier_annuel', employe_id=employe.id) }}" class="button is-fullwidth is-primary">Mois</a></li>
					<li><a href="{{ url_for('vue_aujourdhui') }}" class="button is-fullwidth is-light">Jour</a></li>
				</ul>
			</nav>
			<!-- Mini calendrier -->
			<div id="mini-calendar"></div>
		</aside>
		<!-- Contenu principal -->
		<div style="flex:1;">
			<div style="max-width: 900px; margin: 0 auto; background: #fff; border-radius: 24px; box-shadow: 0 4px 32px #e0e0e0; padding: 2.5rem 2rem 2rem 2rem;">
			<h1 class="title is-3" style="color:#a18aff;">Calendrier mensuel de {{ employe.nom }}</h1>
			<div class="tabs is-toggle is-centered" style="margin-top:2rem;">
				<ul>
					<li class="is-active" id="tab-employe"><a>Présence / Congé</a></li>
					<li id="tab-retouche"><a>Retouches</a></li>
				</ul>
			</div>
			<div id="agenda-employe"></div>
			<div id="agenda-retouche" style="display:none;"></div>
			</div>
		</div>
	</div>
	<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
	<link href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css" rel="stylesheet" />
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			// Mini calendrier VanillaJS Datepicker
			var miniCal = document.getElementById('mini-calendar');
			if (miniCal) {
				var today = new Date();
				var dp = new Datepicker(miniCal, {
					calendarWeeks: true,
					todayHighlight: true,
					autohide: true,
					format: 'yyyy-mm-dd',
					defaultViewDate: { year: today.getFullYear(), month: today.getMonth()+1, day: today.getDate() },
				});
				miniCal.addEventListener('changeDate', function(e) {
					var date = e.detail.date;
					if(date) {
						var y = date.getFullYear();
						var m = (date.getMonth()+1).toString().padStart(2,'0');
						var d = date.getDate().toString().padStart(2,'0');
						window.location.href = '/aujourdhui?date='+y+'-'+m+'-'+d;
					}
				});
			}
			// FullCalendar - Présence/Conge
					var agendaEmployeEl = document.getElementById('agenda-employe');
					var agendaEmploye = new FullCalendar.Calendar(agendaEmployeEl, {
						initialView: 'dayGridMonth',
						locale: 'fr',
						height: 700,
						headerToolbar: {
							left: 'prev,next today',
							center: 'title',
							right: ''
						},
						events: {{ events|tojson|safe }},
						eventDisplay: 'block',
						eventColor: '#a18aff',
						eventTextColor: '#fff',
						selectable: false,
						dayMaxEventRows: true,
						views: {
							dayGridMonth: { dayMaxEventRows: 4 }
						}
					});
					agendaEmploye.render();

					// FullCalendar - Retouches (chargé dynamiquement via AJAX)
					var agendaRetoucheEl = document.getElementById('agenda-retouche');
					var agendaRetouche = new FullCalendar.Calendar(agendaRetoucheEl, {
						initialView: 'dayGridMonth',
						locale: 'fr',
						height: 700,
						headerToolbar: {
							left: 'prev,next today',
							center: 'title',
							right: ''
						},
						events: function(fetchInfo, successCallback, failureCallback) {
							fetch('/api/retouches_mois?employe_id={{ employe.id }}&mois='+(fetchInfo.start.getMonth()+1)+'&annee='+fetchInfo.start.getFullYear())
							  .then(response => response.json())
							  .then(data => successCallback(data))
							  .catch(failureCallback);
						},
						eventDisplay: 'block',
						eventColor: '#ffb347',
						eventTextColor: '#222',
						selectable: false,
						dayMaxEventRows: true,
						views: {
							dayGridMonth: { dayMaxEventRows: 4 }
						}
					});

					// Onglets
					document.getElementById('tab-employe').onclick = function() {
					  this.classList.add('is-active');
					  document.getElementById('tab-retouche').classList.remove('is-active');
					  agendaEmployeEl.style.display = '';
					  agendaRetoucheEl.style.display = 'none';
					};
					document.getElementById('tab-retouche').onclick = function() {
					  this.classList.add('is-active');
					  document.getElementById('tab-employe').classList.remove('is-active');
					  agendaEmployeEl.style.display = 'none';
					  agendaRetoucheEl.style.display = '';
					  agendaRetouche.render();
					};
		});
	</script>
</section>
{% endblock %}
