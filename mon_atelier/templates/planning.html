{% extends 'base.html' %}

{% block content %}


<section class="section" style="background: #f8f9fa; min-height: 100vh;">
    <div style="display:flex; max-width: 1400px; margin: 0 auto;">
        <!-- Sidebar -->
        <aside style="width: 240px; min-width:200px; background: #f6f6ff; border-radius: 18px; box-shadow: 0 2px 8px #ececff; padding: 2rem 1rem 1.5rem 1rem; margin-right:2.5rem; display:flex; flex-direction:column; align-items:center;">
            <!-- Menu navigation -->
            <nav style="width:100%; margin-bottom:2rem;">
                <ul style="list-style:none; padding:0; margin:0;">
                    <li style="margin-bottom:1rem;"><a href="{{ url_for('planning') }}" class="button is-fullwidth is-primary">Semaine</a></li>
                    <li style="margin-bottom:1rem;"><a href="{{ url_for('planning_retouches_mensuel') }}" class="button is-fullwidth is-light">Mois</a></li>
                </ul>
            </nav>
            <!-- Mini calendrier -->
            <div id="mini-calendar"></div>
        </aside>
        <!-- Contenu principal -->
        <div style="flex:1;">
            <div style="max-width: 1100px; margin: 0 auto; background: #fff; border-radius: 24px; box-shadow: 0 4px 32px #e0e0e0; padding: 2.5rem 2rem 2rem 2rem;">
        <div class="level" style="margin-bottom:1.5rem;">
            <div class="level-left">
                <a href="{{ url_for('planning', semaine=semaine-1) }}" class="button">◄ Précédent</a>
            </div>
            <div class="level-item">
                <h1 class="title is-3" style="color:#a18aff; margin-bottom:0;">Planning hebdomadaire</h1>
            </div>
            <div class="level-right">
                <a href="{{ url_for('planning', semaine=semaine+1) }}" class="button">Suivant ►</a>
            </div>
        </div>
        <h2 class="subtitle" style="text-align:center; margin-bottom:2rem;">Semaine du {{ start_week.strftime('%d/%m') }} au {{ (start_week + timedelta(days=4)).strftime('%d/%m/%Y') }}</h2>
        <!-- Affichage du planning résumé -->
        {% if planning_resume %}
            {% for client, items in planning_resume %}
                <div class="box" style="margin-bottom:1.5rem;">
                    <div style="font-weight: bold; font-size: 1.2em; color:#6c63ff; margin-bottom:0.3em;">{{ client }}</div>
                    <ul style="margin:0; padding-left:1.2em;">
                        {% for item in items %}
                            <li style="font-size: 1em; color:#444; list-style: disc;">
                                <span style="font-weight:600;">{{ item.quantite }}</span> {{ item.nom }}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endfor %}
        {% else %}
            <p>Aucune retouche prévue cette semaine.</p>
        {% endif %}
            </div>
        </div>
    </div>
</section>

<div id="client-actions-modal" class="modal">
<link href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>
<script>
// Mini calendrier VanillaJS Datepicker
document.addEventListener('DOMContentLoaded', function() {
    var miniCal = document.getElementById('mini-calendar');
    if (miniCal) {
        var today = new Date();
        var dp = new Datepicker(miniCal, {
            calendarWeeks: true,
            todayHighlight: true,
            autohide: true,
            format: 'yyyy-mm-dd',
            defaultViewDate: { year: today.getFullYear(), month: today.getMonth()+1, day: today.getDate() },
        });
        miniCal.addEventListener('changeDate', function(e) {
            // Redirige vers la vue du jour sélectionné (si besoin, adapter l'URL)
            var date = e.detail.date;
            if(date) {
                var y = date.getFullYear();
                var m = (date.getMonth()+1).toString().padStart(2,'0');
                var d = date.getDate().toString().padStart(2,'0');
                window.location.href = '/aujourdhui?date='+y+'-'+m+'-'+d;
            }
        });
    }
    // Agenda mensuel FullCalendar
    var agendaEl = document.getElementById('agenda-mensuel');
    if (agendaEl) {
        var agenda = new FullCalendar.Calendar(agendaEl, {
            initialView: 'dayGridMonth',
            locale: 'fr',
            height: 600,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: ''
            },
            events: '/api/retouche_events',
            eventDisplay: 'block',
            eventColor: '#a18aff',
            eventTextColor: '#fff',
            selectable: false,
            dayMaxEventRows: true,
            views: {
                dayGridMonth: { dayMaxEventRows: 4 }
            },
            eventDidMount: function(info) {
                // Si l'événement a le statut "Terminée", on le barre
                if (info.event.extendedProps && info.event.extendedProps.statut === 'Terminée') {
                    info.el.style.textDecoration = 'line-through';
                    info.el.style.opacity = '0.6';
                }
            }
        });
        agenda.render();
    }
});
</script>
        // Assembler la boîte
        retoucheBox.appendChild(descriptionP);
        retoucheBox.appendChild(hr);
        retoucheBox.appendChild(levelDiv);

        // Ajouter à la liste
        retoucheListDiv.appendChild(retoucheBox);
    });
    modal.classList.add('is-active');
}
function closeModal() {
    document.getElementById('client-actions-modal').classList.remove('is-active');
}
document.querySelectorAll('.delete, .modal-background').forEach(button => button.addEventListener('click', closeModal));
document.addEventListener('keydown', (event) => {
    if (event.key === "Escape") closeModal();
});
</script>
{% endblock %}